<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Management Conflict Handling Policy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #0078d4;
            text-align: center;
        }
        .question-container {
            background-color: #f3f2f1;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .drag-drop-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .drag-source {
            flex: 1;
            background-color: #f3f2f1;
            padding: 15px;
            border-radius: 5px;
            min-height: 300px;
        }
        .drop-target {
            flex: 2;
            background-color: #e5f5ff;
            padding: 15px;
            border-radius: 5px;
            min-height: 300px;
        }
        .drag-item {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: move;
        }
        .drag-item:hover {
            background-color: #f0f0f0;
        }
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: Consolas, 'Courier New', monospace;
            white-space: pre;
            overflow-x: auto;
        }
        .policy-segment {
            background-color: #3a3a3a;
            color: #ffcc00;
            padding: 2px 5px;
            border-radius: 3px;
            margin: 5px 0;
            display: inline-block;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #005a9e;
        }
        .answer-section {
            display: none;
            margin-top: 30px;
            background-color: #f3f2f1;
            padding: 20px;
            border-radius: 5px;
        }
        .answer-section h3 {
            color: #0078d4;
            margin-top: 0;
        }
        .correct-answer {
            background-color: #dff6dd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .explanation {
            background-color: white;
            padding: 15px;
            border-radius: 4px;
        }
        @media (max-width: 768px) {
            .drag-drop-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>QUESTION NO: 260 DRAG DROP</h1>
    
    <div class="question-container">
        <p>You are developing a REST web service. Customers will access the service by using an Azure API Management instance.</p>
        <p>The web service does not correctly handle conflicts. Instead of returning an HTTP status code of 409, the service returns a status code of 500. The body of the status message contains only the word "conflict".</p>
        <p>You need to ensure that conflicts produce the correct response.</p>
        <p>How should you complete the policy? To answer, drag the appropriate code segments to the correct locations. Each code segment may be used once, more than once, or not at all.</p>
        <p><strong>NOTE:</strong> Each correct selection is worth one point.</p>
    </div>
    
    <div class="drag-drop-container">
        <div class="drag-source" id="source">
            <div class="drag-item" draggable="true" data-id="server">server</div>
            <div class="drag-item" draggable="true" data-id="context">context</div>
            <div class="drag-item" draggable="true" data-id="on-error">on-error</div>
            <div class="drag-item" draggable="true" data-id="set-status">set-status</div>
            <div class="drag-item" draggable="true" data-id="when-error">when-error</div>
            <div class="drag-item" draggable="true" data-id="override-status">override-status</div>
        </div>
        <div class="drop-target" id="target">
            <div class="code-block">
&lt;<span class="policy-segment" data-placeholder="policy-segment">policy-segment</span>&gt;
&lt;base/&gt;
  &lt;choose&gt;
    &lt;when condition="<span class="policy-segment" data-placeholder="policy-segment">policy-segment</span>.Response.StatusCode == 500 &amp;&amp; <span class="policy-segment" data-placeholder="policy-segment">policy-segment</span>.LastError.Message.Contains('conflict')"&gt;
      &lt;return-response&gt;
        &lt;<span class="policy-segment" data-placeholder="policy-segment">policy-segment</span>&gt;
      &lt;/return-response&gt;
    &lt;/when&gt;
    &lt;otherwise/&gt;
  &lt;/choose&gt;
  &lt;/<span class="policy-segment" data-placeholder="policy-segment">policy-segment</span>&gt;
            </div>
        </div>
    </div>
    
    <div class="button-container">
        <button id="check-answer">Check Answer</button>
    </div>
    
    <div id="answer-section" class="answer-section">
        <h3>Correct Answer and Explanation</h3>
        <div class="correct-answer">
            <p><strong>Correct Selections:</strong></p>
            <ol>
                <li>First segment: on-error</li>
                <li>Second segment: context</li>
                <li>Third segment: context</li>
                <li>Fourth segment: set-status</li>
                <li>Fifth segment: on-error</li>
            </ol>
        </div>
        <div class="explanation">
            <p><strong>中文说明：</strong></p>
            <p>1. <strong>第一个segment: on-error</strong></p>
            <ul>
                <li>整个策略包裹在on-error块中</li>
                <li>这是API Management错误处理的标准做法</li>
            </ul>
            
            <p>2. <strong>第二个和第三个segment: context</strong></p>
            <ul>
                <li>用于访问响应状态码和错误消息</li>
                <li>context.Response.StatusCode 获取当前响应状态码</li>
                <li>context.LastError.Message 获取最后一个错误消息</li>
            </ul>
            
            <p>3. <strong>第四个segment: set-status</strong></p>
            <ul>
                <li>设置HTTP状态码为409 Conflict</li>
                <li>这是正确处理冲突的标准HTTP状态码</li>
            </ul>
            
            <p>4. <strong>第五个segment: on-error</strong></p>
            <ul>
                <li>结束on-error块</li>
                <li>与第一个segment配对</li>
            </ul>
            
            <p><strong>技术说明：</strong></p>
            <ul>
                <li>策略首先检查500错误且包含"conflict"消息</li>
                <li>将状态码从500改为409 Conflict</li>
                <li>返回结构化的错误响应体</li>
                <li>符合REST API最佳实践</li>
            </ul>
            
            <p><strong>完整策略示例：</strong></p>
            <pre>&lt;on-error&gt;
&lt;base/&gt;
  &lt;choose&gt;
    &lt;when condition="context.Response.StatusCode == 500 &amp;&amp; context.LastError.Message.Contains('conflict')"&gt;
      &lt;return-response&gt;
        &lt;set-status code="409" reason="Conflict"/&gt;
      &lt;/return-response&gt;
    &lt;/when&gt;
    &lt;otherwise/&gt;
  &lt;/choose&gt;
&lt;/on-error&gt;</pre>
            
            <p><strong>参考文档：</strong> <a href="https://docs.microsoft.com/en-us/azure/api-management/api-management-error-handling-policies" target="_blank">API Management错误处理策略</a></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const source = document.getElementById('source');
            const target = document.getElementById('target');
            const checkAnswerBtn = document.getElementById('check-answer');
            const answerSection = document.getElementById('answer-section');
            const policySegments = document.querySelectorAll('.policy-segment');
            
            let draggedItem = null;
            
            // Drag start event
            source.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('drag-item')) {
                    draggedItem = e.target;
                    e.dataTransfer.setData('text/plain', e.target.dataset.id);
                    setTimeout(() => {
                        e.target.style.opacity = '0.4';
                    }, 0);
                }
            });
            
            // Drag end event
            source.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('drag-item')) {
                    setTimeout(() => {
                        e.target.style.opacity = '1';
                        draggedItem = null;
                    }, 0);
                }
            });
            
            // Drag over event for policy segments
            policySegments.forEach(segment => {
                segment.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                segment.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (draggedItem) {
                        // Replace the segment with the dragged item's text
                        this.textContent = draggedItem.textContent;
                        this.style.backgroundColor = '#4CAF50';
                        this.style.color = 'white';
                        
                        // Store the original placeholder type
                        this.dataset.originalPlaceholder = this.dataset.placeholder;
                        this.dataset.placeholder = draggedItem.dataset.id;
                    }
                });
            });
            
            // Check answer button
            checkAnswerBtn.addEventListener('click', function() {
                // Validate answers
                const correctAnswers = {
                    'policy-segment': ['on-error', 'context', 'context', 'set-status', 'on-error']
                };
                
                let isCorrect = true;
                policySegments.forEach((segment, index) => {
                    const userAnswer = segment.textContent;
                    const correctAnswer = correctAnswers['policy-segment'][index];
                    
                    if (userAnswer !== correctAnswer) {
                        isCorrect = false;
                        segment.style.backgroundColor = '#FF5722';
                    } else {
                        segment.style.backgroundColor = '#4CAF50';
                    }
                });
                
                answerSection.style.display = 'block';
                window.scrollTo({
                    top: answerSection.offsetTop,
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>
</html>
